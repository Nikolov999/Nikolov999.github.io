<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>EchoPentest Client Portal</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- Your shared site styles (navbar/footer etc.) -->
  <link rel="stylesheet" href="style.css" />
  <link rel="icon" type="image/png" href="Logo/Logo.png">
  <!-- Shared nav/footer loader -->
  <script src="main.js" defer></script>
  <!-- Chart.js for risk trend chart -->
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root {
      --cp-bg: #050816;
      --cp-card-bg: #0f172a;
      --cp-card-border: #1f2937;
      --cp-accent: #7c3aed;
      --cp-accent-soft: rgba(124, 58, 237, 0.2);
      --cp-accent-alt: #22d3ee;
      --cp-text-main: #e5e7eb;
      --cp-text-muted: #9ca3af;
      --cp-danger: #f97373;
      --cp-success: #4ade80;
    }

    /* Entire portal is scoped here – nothing leaks into nav/footer */
    #client-portal-root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #1f2937 0, #020617 55%);
      color: var(--cp-text-main);
    }

    #client-portal-root .cp-portal-wrapper {
      max-width: 1100px;
      margin: 0 auto;
      padding: 1.5rem 1.25rem 3rem;
    }

    /* HERO */

    #client-portal-root .cp-hero {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin-bottom: 1.75rem;
      padding: 1.25rem 1.5rem;
      border-radius: 1rem;
      background: radial-gradient(circle at top left, #1e293b 0, #020617 60%);
      border: 1px solid rgba(148, 163, 184, 0.25);
      position: relative;
      overflow: hidden;
    }

    #client-portal-root .cp-hero::before {
      content: "";
      position: absolute;
      width: 260px;
      height: 260px;
      background: radial-gradient(circle, var(--cp-accent-soft), transparent 60%);
      top: -120px;
      right: -60px;
      opacity: 0.9;
      pointer-events: none;
    }

    #client-portal-root .cp-hero-kicker {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.07em;
      color: var(--cp-accent-alt);
    }

    #client-portal-root .cp-hero-badge {
      padding: 0.18rem 0.55rem;
      border-radius: 999px;
      background-color: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(56, 189, 248, 0.3);
    }

    #client-portal-root .cp-hero-title {
      font-size: 1.7rem;
      font-weight: 700;
      letter-spacing: 0.03em;
    }

    #client-portal-root .cp-hero-sub {
      max-width: 640px;
      font-size: 0.95rem;
      color: var(--cp-text-muted);
    }

    #client-portal-root .cp-hero-bullets {
      display: flex;
      flex-wrap: wrap;
      gap: 0.75rem;
      margin-top: 0.5rem;
      font-size: 0.8rem;
    }

    #client-portal-root .cp-hero-bullet {
      padding: 0.3rem 0.7rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background: rgba(15, 23, 42, 0.9);
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      color: var(--cp-text-muted);
    }

    #client-portal-root .cp-hero-bullet-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--cp-accent-alt);
    }

    #client-portal-root .cp-hero-status {
      margin-top: 0.75rem;
      font-size: 0.8rem;
      display: flex;
      align-items: center;
      gap: 0.4rem;
      color: var(--cp-text-muted);
    }

    #client-portal-root .cp-hero-status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--cp-success);
      box-shadow: 0 0 14px rgba(74, 222, 128, 0.9);
    }

    #client-portal-root .cp-hero-typing {
      font-family: "JetBrains Mono", ui-monospace, SFMono-Regular, Menlo,
        Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.78rem;
      color: var(--cp-accent-alt);
      opacity: 0.85;
      margin-top: 0.3rem;
      white-space: nowrap;
      overflow: hidden;
      border-right: 2px solid var(--cp-accent-alt);
    }

    /* LAYOUT */

    #client-portal-root .cp-layout {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.7fr);
      gap: 1.5rem;
    }

    @media (max-width: 900px) {
      #client-portal-root .cp-layout {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    /* CARDS */

    #client-portal-root .cp-card {
      background: var(--cp-card-bg);
      border-radius: 0.9rem;
      padding: 1.1rem 1.2rem;
      border: 1px solid var(--cp-card-border);
      box-shadow: 0 18px 50px rgba(15, 23, 42, 0.6);
      position: relative;
      overflow: hidden;
    }

    #client-portal-root .cp-card::before {
      content: "";
      position: absolute;
      inset: 0;
      opacity: 0;
      pointer-events: none;
      background: radial-gradient(
        circle at top left,
        rgba(124, 58, 237, 0.16),
        transparent 60%
      );
      transition: opacity 0.25s ease;
    }

    #client-portal-root .cp-card:hover::before {
      opacity: 1;
    }

    #client-portal-root .cp-card-header {
      display: flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 0.5rem;
      margin-bottom: 0.9rem;
    }

    #client-portal-root .cp-card-title {
      font-size: 1rem;
      font-weight: 600;
    }

    #client-portal-root .cp-card-sub {
      font-size: 0.8rem;
      color: var(--cp-text-muted);
    }

    /* INPUTS / BUTTONS */

    #client-portal-root .cp-field {
      display: flex;
      flex-direction: column;
      gap: 0.25rem;
      margin-bottom: 0.7rem;
    }

    #client-portal-root .cp-field label {
      font-size: 0.8rem;
      color: var(--cp-text-muted);
    }

    #client-portal-root .cp-field input {
      padding: 0.5rem 0.65rem;
      border-radius: 0.5rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background-color: rgba(15, 23, 42, 0.93);
      color: var(--cp-text-main);
      outline: none;
      font-size: 0.88rem;
      transition: border-color 0.2s ease, background-color 0.2s ease,
        box-shadow 0.2s ease;
    }

    #client-portal-root .cp-field input:focus {
      border-color: var(--cp-accent);
      background-color: #020617;
      box-shadow: 0 0 0 1px rgba(124, 58, 237, 0.4);
    }

    #client-portal-root .cp-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 0.4rem;
      padding: 0.55rem 0.9rem;
      border-radius: 0.7rem;
      border: none;
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      background: linear-gradient(135deg, var(--cp-accent), #4f46e5);
      color: white;
      box-shadow: 0 14px 40px rgba(88, 28, 135, 0.7);
      transition: transform 0.07s ease, box-shadow 0.07s ease,
        filter 0.07s ease;
    }

    #client-portal-root .cp-btn:active {
      transform: translateY(1px) scale(0.99);
      box-shadow: 0 8px 25px rgba(88, 28, 135, 0.7);
      filter: brightness(0.93);
    }

    #client-portal-root .cp-btn.cp-outline {
      background: transparent;
      border: 1px solid rgba(148, 163, 184, 0.5);
      color: var(--cp-text-muted);
      box-shadow: none;
    }

    #client-portal-root .cp-btn.cp-outline:hover {
      border-color: var(--cp-accent-alt);
      color: var(--cp-accent-alt);
    }

    #client-portal-root .cp-btn-full {
      width: 100%;
      margin-top: 0.3rem;
    }

    #client-portal-root .cp-error-text {
      font-size: 0.78rem;
      color: var(--cp-danger);
      margin-top: 0.25rem;
      min-height: 1.1em;
    }

    #client-portal-root .cp-hint {
      font-size: 0.75rem;
      color: var(--cp-text-muted);
      margin-top: 0.25rem;
    }

    #client-portal-root .cp-status-pill {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      font-size: 0.78rem;
      padding: 0.25rem 0.6rem;
      border-radius: 999px;
      background-color: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--cp-text-muted);
    }

    #client-portal-root .cp-status-dot {
      width: 7px;
      height: 7px;
      border-radius: 999px;
      background: var(--cp-success);
      box-shadow: 0 0 12px rgba(74, 222, 128, 1);
    }

    /* DASHBOARD */

    #client-portal-root .cp-dashboard {
      display: none;
      flex-direction: column;
      gap: 1.2rem;
      margin-top: 0.5rem;
    }

    #client-portal-root .cp-dashboard.cp-active {
      display: flex;
    }

    #client-portal-root .cp-dashboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 0.9rem;
    }

    #client-portal-root .cp-dashboard-title {
      font-size: 1.1rem;
      font-weight: 600;
    }

    #client-portal-root .cp-dashboard-sub {
      font-size: 0.82rem;
      color: var(--cp-text-muted);
    }

    #client-portal-root .cp-dashboard-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.1fr) minmax(0, 1.3fr);
      gap: 1.1rem;
    }

    @media (max-width: 900px) {
      #client-portal-root .cp-dashboard-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    #client-portal-root .cp-engagement-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.45rem;
      margin-top: 0.4rem;
      max-height: 260px;
      overflow: auto;
      font-size: 0.85rem;
    }

    #client-portal-root .cp-engagement-item {
      padding: 0.5rem 0.6rem;
      border-radius: 0.55rem;
      border: 1px solid rgba(55, 65, 81, 0.8);
      background-color: rgba(15, 23, 42, 0.9);
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
      cursor: pointer;
      transition: border-color 0.15s ease, background-color 0.15s ease,
        transform 0.05s ease;
    }

    #client-portal-root .cp-engagement-item:hover {
      border-color: var(--cp-accent-alt);
      background-color: #020617;
    }

    #client-portal-root .cp-engagement-item.cp-active {
      border-color: var(--cp-accent);
      box-shadow: 0 0 0 1px rgba(124, 58, 237, 0.5);
    }

    #client-portal-root .cp-engagement-title {
      font-weight: 500;
    }

    #client-portal-root .cp-engagement-status {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.08em;
      padding: 0.15rem 0.5rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      color: var(--cp-text-muted);
    }

    #client-portal-root .cp-engagement-status.active {
      border-color: rgba(45, 212, 191, 0.7);
      color: var(--cp-accent-alt);
    }

    #client-portal-root .cp-engagement-status.completed {
      border-color: rgba(74, 222, 128, 0.7);
      color: var(--cp-success);
    }

    /* MESSAGES & FILES */

    #client-portal-root .cp-messages-container {
      margin-top: 0.4rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background-color: rgba(15, 23, 42, 0.97);
      max-height: 260px;
      min-height: 140px;
      padding: 0.55rem 0.6rem;
      overflow-y: auto;
      font-size: 0.82rem;
    }

    #client-portal-root .cp-message-bubble {
      max-width: 80%;
      padding: 0.45rem 0.6rem;
      border-radius: 0.8rem;
      margin-bottom: 0.35rem;
      line-height: 1.3;
      word-wrap: break-word;
    }

    #client-portal-root .cp-message-bubble.client {
      margin-right: auto;
      background-color: rgba(31, 41, 55, 0.95);
      border-bottom-left-radius: 0.15rem;
      border: 1px solid rgba(75, 85, 99, 0.8);
    }

    #client-portal-root .cp-message-bubble.admin {
      margin-left: auto;
      background: linear-gradient(135deg, #4f46e5, var(--cp-accent));
      border-bottom-right-radius: 0.15rem;
      box-shadow: 0 14px 38px rgba(79, 70, 229, 0.65);
    }

    #client-portal-root .cp-message-meta {
      font-size: 0.65rem;
      color: var(--cp-text-muted);
      margin-bottom: 0.2rem;
      display: flex;
      justify-content: space-between;
    }

    #client-portal-root .cp-message-input-wrapper {
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      margin-top: 0.5rem;
    }

    #client-portal-root .cp-message-input-wrapper textarea {
      resize: vertical;
      min-height: 70px;
      max-height: 130px;
      padding: 0.5rem 0.6rem;
      border-radius: 0.6rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background-color: rgba(15, 23, 42, 0.97);
      color: var(--cp-text-main);
      outline: none;
      font-size: 0.86rem;
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
    }

    #client-portal-root .cp-message-input-wrapper textarea:focus {
      border-color: var(--cp-accent);
      box-shadow: 0 0 0 1px rgba(124, 58, 237, 0.5);
    }

    #client-portal-root .cp-message-actions {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
      flex-wrap: wrap;
    }

    #client-portal-root .cp-tiny-text {
      font-size: 0.72rem;
      color: var(--cp-text-muted);
    }

    #client-portal-root .cp-files-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-top: 0.3rem;
      max-height: 160px;
      overflow-y: auto;
      font-size: 0.82rem;
    }

    #client-portal-root .cp-files-list li a {
      color: var(--cp-accent-alt);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
    }

    #client-portal-root .cp-files-list li a:hover {
      text-decoration: underline;
    }

    #client-portal-root .cp-file-upload-row {
      display: flex;
      gap: 0.4rem;
      align-items: center;
      margin-top: 0.6rem;
      flex-wrap: wrap;
    }

    #client-portal-root .cp-file-upload-row input[type="file"] {
      font-size: 0.78rem;
      color: var(--cp-text-muted);
      max-width: 220px;
    }

    #client-portal-root .cp-upload-status {
      font-size: 0.75rem;
      color: var(--cp-text-muted);
      margin-top: 0.2rem;
    }

    #client-portal-root .cp-hidden {
      display: none !important;
    }

    /* RISK DASHBOARD */

    #client-portal-root .cp-risk-grid {
      display: grid;
      grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
      gap: 0.9rem;
      margin-top: 0.75rem;
      margin-bottom: 0.75rem;
    }

    @media (max-width: 900px) {
      #client-portal-root .cp-risk-grid {
        grid-template-columns: minmax(0, 1fr);
      }
    }

    #client-portal-root .cp-risk-card {
      border-radius: 0.7rem;
      border: 1px solid rgba(55, 65, 81, 0.9);
      background-color: rgba(15, 23, 42, 0.96);
      padding: 0.7rem 0.8rem;
      font-size: 0.82rem;
    }

    #client-portal-root .cp-risk-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.6rem;
      margin-bottom: 0.4rem;
    }

    #client-portal-root .cp-risk-title {
      font-weight: 500;
      font-size: 0.95rem;
    }

    #client-portal-root .cp-risk-pill {
      font-size: 0.72rem;
      padding: 0.18rem 0.55rem;
      border-radius: 999px;
      border: 1px solid rgba(148, 163, 184, 0.4);
      background-color: rgba(15, 23, 42, 0.96);
      color: var(--cp-text-muted);
      white-space: nowrap;
    }

    #client-portal-root .cp-risk-pill.low {
      border-color: rgba(34, 197, 94, 0.7);
      color: #4ade80;
    }

    #client-portal-root .cp-risk-pill.medium {
      border-color: rgba(234, 179, 8, 0.7);
      color: #facc15;
    }

    #client-portal-root .cp-risk-pill.high {
      border-color: rgba(249, 115, 22, 0.7);
      color: #fb923c;
    }

    #client-portal-root .cp-risk-pill.critical {
      border-color: rgba(248, 113, 113, 0.8);
      color: #fb7185;
    }

    #client-portal-root .cp-risk-caption {
      margin-top: 0.4rem;
      font-size: 0.74rem;
      color: var(--cp-text-muted);
    }

    #client-portal-root .cp-findings-summary-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: grid;
      gap: 0.3rem;
      font-size: 0.8rem;
    }

    #client-portal-root .cp-findings-summary-list li {
      display: flex;
      justify-content: space-between;
      gap: 0.4rem;
      color: var(--cp-text-muted);
    }

    #client-portal-root .cp-findings-summary-list span:first-child {
      color: var(--cp-text-main);
    }
  </style>
</head>
<body>
  <div id="nav-placeholder"></div>

  <div id="client-portal-root">
    <div class="cp-portal-wrapper">
      <!-- HERO -->
      <section class="cp-hero">
        <div class="cp-hero-kicker">
          <span class="cp-hero-badge">EchoPentest</span>
          <span>Client Portal</span>
        </div>
        <h1 class="cp-hero-title">Secure portal for reports, evidence &amp; comms.</h1>
        <p class="cp-hero-sub">
          Log in to review engagement progress, download pentest reports,
          upload evidence, and message EchoPentest directly over an encrypted,
          audit-logged channel.
        </p>
        <div class="cp-hero-bullets">
          <span class="cp-hero-bullet">
            <span class="cp-hero-bullet-dot"></span>
            Real-time engagement overview
          </span>
          <span class="cp-hero-bullet">
            <span class="cp-hero-bullet-dot"></span>
            Secure file delivery &amp; evidence upload
          </span>
          <span class="cp-hero-bullet">
            <span class="cp-hero-bullet-dot"></span>
            Conversation history preserved for every test
          </span>
        </div>
        <div class="cp-hero-status">
          <span class="cp-hero-status-dot"></span>
          <span id="cp-hero-status-text">Portal status: ready for authenticated clients.</span>
        </div>
        <div class="cp-hero-typing" id="cp-hero-typing"></div>
      </section>

      <!-- MAIN LAYOUT -->
      <section class="cp-layout">
        <!-- LOGIN -->
        <section class="cp-card">
          <div class="cp-card-header">
            <div>
              <div class="cp-card-title">Sign in</div>
              <div class="cp-card-sub">
                Use the credentials shared with you by EchoPentest.
              </div>
            </div>
            <div class="cp-status-pill" id="cp-session-pill">
              <span class="cp-status-dot"></span>
              <span id="cp-session-status">Logged out</span>
            </div>
          </div>

          <div id="cp-login-section">
            <div class="cp-field">
              <label for="cp-login-email">Business email</label>
              <input type="email" id="cp-login-email" placeholder="you@company.com" autocomplete="email" />
            </div>

            <div class="cp-field">
              <label for="cp-login-password">Password</label>
              <input type="password" id="cp-login-password" placeholder="••••••••" autocomplete="current-password" />
            </div>

            <button class="cp-btn cp-btn-full" id="cp-login-btn">
              Sign in securely
            </button>

            <div class="cp-error-text" id="cp-login-error"></div>
            <p class="cp-hint">
              Forgot your login? Contact EchoPentest and we’ll re-issue access securely.
            </p>
          </div>

          <div id="cp-logout-section" class="cp-hidden">
            <p class="cp-hint">
              You’re logged in as <span id="cp-current-email"></span>. Use the
              controls on the right to navigate your engagement.
            </p>
            <button class="cp-btn cp-outline cp-btn-full" id="cp-logout-btn">
              Log out
            </button>
          </div>
        </section>

        <!-- DASHBOARD -->
        <section class="cp-card">
          <div class="cp-dashboard-header">
            <div>
              <div class="cp-dashboard-title">
                Engagement overview
              </div>
              <div class="cp-dashboard-sub" id="cp-dashboard-sub">
                Sign in to see your active and historical tests.
              </div>
            </div>
          </div>

          <div class="cp-dashboard" id="cp-dashboard">

            <!-- RISK OVERVIEW -->
            <div class="cp-risk-grid">
              <div class="cp-risk-card">
                <div class="cp-risk-header">
                  <div class="cp-risk-title">Risk score over time</div>
                  <span id="cp-risk-pill" class="cp-risk-pill">No data yet</span>
                </div>
                <canvas id="cp-risk-chart" height="110"></canvas>
                <div id="cp-risk-caption" class="cp-risk-caption">
                  Once your first assessment is completed, your risk trend will appear here.
                </div>
              </div>
              <div class="cp-risk-card">
                <div class="cp-risk-header">
                  <div class="cp-risk-title">Findings summary</div>
                </div>
                <ul id="cp-findings-summary" class="cp-findings-summary-list">
                  <li><span>Severity / Status</span><span>Count</span></li>
                </ul>
              </div>
            </div>

            <!-- Engagements + Messages -->
            <div class="cp-dashboard-grid">
              <!-- Engagements -->
              <div>
                <div class="cp-card-sub">Your engagements</div>
                <ul id="cp-engagement-list" class="cp-engagement-list">
                  <li class="cp-tiny-text">
                    No engagements loaded yet.
                  </li>
                </ul>
              </div>

              <!-- Messages -->
              <div>
                <div class="cp-card-sub">Messages</div>
                <div id="cp-messages-container" class="cp-messages-container">
                  <p class="cp-tiny-text">Select an engagement to view messages.</p>
                </div>
                <div class="cp-message-input-wrapper" id="cp-message-input-wrapper">
                  <textarea
                    id="cp-message-text"
                    placeholder="Type a message to EchoPentest about this engagement..."
                  ></textarea>
                  <div class="cp-message-actions">
                    <button class="cp-btn" id="cp-send-message-btn">
                      Send message
                    </button>
                    <span class="cp-tiny-text">
                      Channel is monitored during agreed testing hours.
                    </span>
                  </div>
                </div>
              </div>
            </div>

            <!-- Files -->
            <div style="margin-top: 1rem;">
              <div class="cp-card-sub">Files &amp; reports</div>
              <ul id="cp-files-list" class="cp-files-list">
                <li class="cp-tiny-text">No files yet.</li>
              </ul>

              <div class="cp-file-upload-row">
                <input type="file" id="cp-file-upload" />
                <button class="cp-btn cp-outline" id="cp-upload-btn">
                  Upload evidence
                </button>
              </div>
              <div class="cp-upload-status" id="cp-upload-status"></div>
            </div>
          </div>
        </section>
      </section>
    </div>
  </div>

  <div id="footer-placeholder"></div>

  <script>
    // ===== CONFIG =====
    // TODO: change this to your actual Render backend URL
    const API_BASE = "https://echopentest-client-portal-backend.onrender.com";

    // ===== STATE =====
    let cpAuthToken = null;
    let cpCurrentEngagementId = null;
    let cpCurrentEmail = null;
    let cpRiskChart = null;

    const $cp = (id) => document.getElementById(id);

    function cpAuthHeaders() {
      return cpAuthToken ? { Authorization: "Bearer " + cpAuthToken } : {};
    }

    function classifyRisk(score) {
      if (score === null || score === undefined) {
        return { label: "Not scored", className: "" };
      }
      if (score <= 25) return { label: "Very low", className: "low" };
      if (score <= 50) return { label: "Low–medium", className: "low" };
      if (score <= 70) return { label: "Medium", className: "medium" };
      if (score <= 85) return { label: "High", className: "high" };
      return { label: "Critical", className: "critical" };
    }

    function cpSetSessionStatus(text, loggedIn) {
      $cp("cp-session-status").textContent = text;
      const pill = $cp("cp-session-pill");
      if (loggedIn) pill.classList.add("cp-active");
      else pill.classList.remove("cp-active");
    }

    function cpSetHeroStatus(text) {
      $cp("cp-hero-status-text").textContent = text;
    }

    function cpSetDashboardSubtitle(text) {
      $cp("cp-dashboard-sub").textContent = text;
    }

    function cpSetError(id, message) {
      $cp(id).textContent = message || "";
    }

    function cpClear(el) {
      while (el.firstChild) el.removeChild(el.firstChild);
    }

    // Typing effect
    const cpTypingLines = [
      "Initializing encrypted client channel…",
      "Attaching to engagement timeline…",
      "Ready. Use the portal to keep your attack surface honest."
    ];

    function cpStartTypingEffect() {
      const el = $cp("cp-hero-typing");
      let lineIndex = 0, charIndex = 0, deleting = false;

      function tick() {
        const currentLine = cpTypingLines[lineIndex];

        if (!deleting) {
          charIndex++;
          if (charIndex > currentLine.length) {
            deleting = true;
            setTimeout(tick, 1500);
            el.textContent = currentLine;
            return;
          }
        } else {
          charIndex--;
          if (charIndex === 0) {
            deleting = false;
            lineIndex = (lineIndex + 1) % cpTypingLines.length;
          }
        }

        el.textContent = currentLine.slice(0, charIndex);
        setTimeout(tick, deleting ? 40 : 55);
      }
      tick();
    }

    // ===== AUTH =====
    async function cpLogin() {
      const email = $cp("cp-login-email").value.trim();
      const password = $cp("cp-login-password").value.trim();
      cpSetError("cp-login-error", "");

      if (!email || !password) {
        cpSetError("cp-login-error", "Email and password are required.");
        return;
      }

      try {
        cpSetHeroStatus("Attempting secure sign-in…");
        const res = await fetch(API_BASE + "/auth/login", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ email, password }),
        });

        if (!res.ok) {
          cpSetError("cp-login-error", "Invalid credentials.");
          cpSetHeroStatus("Sign-in failed. Check your details and try again.");
          return;
        }

        const data = await res.json();
        cpAuthToken = data.access_token;
        cpCurrentEmail = email;

        $cp("cp-login-section").classList.add("cp-hidden");
        $cp("cp-logout-section").classList.remove("cp-hidden");
        $cp("cp-current-email").textContent = email;

        $cp("cp-dashboard").classList.add("cp-active");
        cpSetSessionStatus("Active session", true);
        cpSetHeroStatus("Authenticated. Loading your engagements…");
        cpSetDashboardSubtitle("Your authenticated portal session is active.");

        await Promise.all([
          cpLoadEngagements(),
          cpLoadRiskDashboard(),
        ]);
      } catch (err) {
        console.error(err);
        cpSetError("cp-login-error", "Something went wrong. Try again.");
        cpSetHeroStatus("Temporary error talking to the API.");
      }
    }

    function cpLogout() {
      cpAuthToken = null;
      cpCurrentEngagementId = null;
      cpCurrentEmail = null;

      $cp("cp-login-section").classList.remove("cp-hidden");
      $cp("cp-logout-section").classList.add("cp-hidden");
      $cp("cp-dashboard").classList.remove("cp-active");

      cpSetSessionStatus("Logged out", false);
      cpSetHeroStatus("Portal status: ready for authenticated clients.");
      cpSetDashboardSubtitle("Sign in to see your active and historical tests.");

      $cp("cp-engagement-list").innerHTML =
        '<li class="cp-tiny-text">No engagements loaded yet.</li>';
      $cp("cp-messages-container").innerHTML =
        '<p class="cp-tiny-text">Select an engagement to view messages.</p>';
      $cp("cp-files-list").innerHTML =
        '<li class="cp-tiny-text">No files yet.</li>';
      $cp("cp-upload-status").textContent = "";
      $cp("cp-login-email").value = "";
      $cp("cp-login-password").value = "";

      // reset risk dashboard
      if (cpRiskChart) {
        cpRiskChart.destroy();
        cpRiskChart = null;
      }
      const pill = $cp("cp-risk-pill");
      const caption = $cp("cp-risk-caption");
      const findingsList = $cp("cp-findings-summary");
      if (pill) {
        pill.textContent = "No data yet";
        pill.className = "cp-risk-pill";
      }
      if (caption) {
        caption.textContent =
          "Once your first assessment is completed, your risk trend will appear here.";
      }
      if (findingsList) {
        cpClear(findingsList);
        const li = document.createElement("li");
        li.innerHTML = "<span>Severity / Status</span><span>Count</span>";
        findingsList.appendChild(li);
      }
    }

    // ===== LOADERS =====
    async function cpLoadEngagements() {
      try {
        const res = await fetch(API_BASE + "/client/engagements", {
          headers: { "Content-Type": "application/json", ...cpAuthHeaders() },
        });

        const list = $cp("cp-engagement-list");
        cpClear(list);

        if (!res.ok) {
          console.error("Failed to load engagements");
          cpSetDashboardSubtitle(
            "Could not load engagements. If this persists, contact EchoPentest."
          );
          return;
        }

        const engagements = await res.json();

        if (!engagements.length) {
          list.innerHTML =
            '<li class="cp-tiny-text">No engagements are currently attached to this account.</li>';
          cpSetDashboardSubtitle(
            "No active engagements yet. EchoPentest will attach tests to this account once booked."
          );
          return;
        }

        engagements.forEach((eng, idx) => {
          const li = document.createElement("li");
          li.className = "cp-engagement-item";
          li.dataset.id = eng.id;

          const title = document.createElement("span");
          title.className = "cp-engagement-title";
          title.textContent = eng.title;

          const status = document.createElement("span");
          status.className = "cp-engagement-status " + eng.status;
          status.textContent = eng.status.toUpperCase();

          li.appendChild(title);
          li.appendChild(status);

          li.addEventListener("click", () => cpSelectEngagement(eng.id));
          list.appendChild(li);

          if (idx === 0) {
            li.classList.add("cp-active");
            cpCurrentEngagementId = eng.id;
          }
        });

        if (cpCurrentEngagementId) {
          await cpLoadMessages(cpCurrentEngagementId);
          await cpLoadFiles(cpCurrentEngagementId);
          $cp("cp-message-input-wrapper").classList.remove("cp-hidden");
        }

        cpSetDashboardSubtitle(
          "Select an engagement to inspect messages, reports and evidence."
        );
      } catch (err) {
        console.error(err);
        cpSetDashboardSubtitle(
          "Error loading engagements. Check your connection or contact EchoPentest."
        );
      }
    }

    async function cpLoadRiskDashboard() {
      if (!cpAuthToken) return;

      try {
        const [historyRes, summaryRes] = await Promise.all([
          fetch(API_BASE + "/client/risk-history", {
            headers: { "Content-Type": "application/json", ...cpAuthHeaders() },
          }),
          fetch(API_BASE + "/client/findings-summary", {
            headers: { "Content-Type": "application/json", ...cpAuthHeaders() },
          }),
        ]);

        const historyData = historyRes.ok ? await historyRes.json() : [];
        const summaryData = summaryRes.ok ? await summaryRes.json() : [];

        cpRenderRiskChart(historyData);
        cpRenderFindingsSummary(summaryData);
      } catch (err) {
        console.error("Error loading risk dashboard:", err);
        const caption = $cp("cp-risk-caption");
        if (caption) {
          caption.textContent =
            "Could not load risk data. If this persists, contact EchoPentest.";
        }
      }
    }

    function cpRenderRiskChart(history) {
      const pill = $cp("cp-risk-pill");
      const caption = $cp("cp-risk-caption");
      const canvas = $cp("cp-risk-chart");
      if (!canvas) return;

      if (!history || !history.length) {
        if (pill) {
          pill.textContent = "No assessments yet";
          pill.className = "cp-risk-pill";
        }
        if (caption) {
          caption.textContent =
            "Once your first assessment is completed, your risk trend will appear here.";
        }
        if (cpRiskChart) {
          cpRiskChart.destroy();
          cpRiskChart = null;
        }
        return;
      }

      const labels = history.map((h) => h.date || "");
      const scores = history.map((h) => h.risk_score ?? null);
      const latest = history[history.length - 1];
      const prev = history.length > 1 ? history[history.length - 2] : null;

      const { label, className } = classifyRisk(latest.risk_score);

      if (pill) {
        pill.textContent = `${label} (${latest.risk_score})`;
        pill.className = "cp-risk-pill " + className;
      }

      if (caption) {
        if (prev && prev.risk_score != null && latest.risk_score != null) {
          const diff = latest.risk_score - prev.risk_score;
          let direction = "stayed the same";
          if (diff < 0) direction = `decreased by ${Math.abs(diff)} points`;
          else if (diff > 0) direction = `increased by ${diff} points`;

          caption.textContent =
            `Latest assessment: "${latest.title || "Assessment"}" on ${
              latest.date || "N/A"
            }. Risk has ${direction} since your previous test.`;
        } else {
          caption.textContent =
            "This is your first scored assessment. Future tests will show how your risk changes over time.";
        }
      }

      if (cpRiskChart) {
        cpRiskChart.destroy();
        cpRiskChart = null;
      }

      const ctx = canvas.getContext("2d");
      cpRiskChart = new Chart(ctx, {
        type: "line",
        data: {
          labels,
          datasets: [
            {
              label: "Risk score",
              data: scores,
              tension: 0.25,
              borderWidth: 2,
              pointRadius: 3,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: { display: false },
          },
          scales: {
            y: {
              suggestedMin: 0,
              suggestedMax: 100,
              title: { display: true, text: "Risk score (0–100)" },
            },
          },
        },
      });
    }

    function cpRenderFindingsSummary(summary) {
      const listEl = $cp("cp-findings-summary");
      if (!listEl) return;

      cpClear(listEl);

      if (!summary || !summary.length) {
        const li = document.createElement("li");
        li.innerHTML = "<span>No findings yet</span><span>0</span>";
        listEl.appendChild(li);
        return;
      }

      summary.forEach((row) => {
        const li = document.createElement("li");
        li.innerHTML = `
          <span>${row.severity} – ${row.status}</span>
          <span>${row.count}</span>
        `;
        listEl.appendChild(li);
      });
    }

    function cpHighlightCurrentEngagement() {
      document
        .querySelectorAll("#client-portal-root .cp-engagement-item")
        .forEach((item) => {
          const id = parseInt(item.dataset.id, 10);
          if (id === cpCurrentEngagementId) item.classList.add("cp-active");
          else item.classList.remove("cp-active");
        });
    }

    async function cpSelectEngagement(id) {
      cpCurrentEngagementId = id;
      cpHighlightCurrentEngagement();
      await cpLoadMessages(id);
      await cpLoadFiles(id);
    }

    async function cpLoadMessages(engagementId) {
      try {
        const res = await fetch(API_BASE + "/messages/" + engagementId, {
          headers: cpAuthHeaders(),
        });

        const container = $cp("cp-messages-container");
        cpClear(container);

        if (!res.ok) {
          console.error("Failed to load messages");
          container.innerHTML =
            '<p class="cp-tiny-text">Could not load messages for this engagement.</p>';
          return;
        }

        const messages = await res.json();

        if (!messages.length) {
          container.innerHTML =
            '<p class="cp-tiny-text">No messages yet. Use the box below to start the conversation.</p>';
          return;
        }

        messages.forEach((m) => {
          const bubble = document.createElement("div");
          bubble.className = "cp-message-bubble " + m.direction;

          const meta = document.createElement("div");
          meta.className = "cp-message-meta";
          const author = m.direction === "admin" ? "EchoPentest" : "You";
          meta.innerHTML =
            "<span>" +
            author +
            "</span><span>" +
            new Date(m.created_at).toLocaleString() +
            "</span>";

          const text = document.createElement("div");
          text.textContent = m.content;

          bubble.appendChild(meta);
          bubble.appendChild(text);
          container.appendChild(bubble);
        });

        container.scrollTop = container.scrollHeight;
      } catch (err) {
        console.error(err);
        $cp("cp-messages-container").innerHTML =
          '<p class="cp-tiny-text">Error loading messages.</p>';
      }
    }

    async function cpSendMessage() {
      if (!cpAuthToken || !cpCurrentEngagementId) return;

      const content = $cp("cp-message-text").value.trim();
      if (!content) return;

      try {
        const res = await fetch(API_BASE + "/messages/", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            ...cpAuthHeaders(),
          },
          body: JSON.stringify({
            engagement_id: cpCurrentEngagementId,
            content,
          }),
        });

        if (!res.ok) {
          console.error("Failed to send message");
          return;
        }

        $cp("cp-message-text").value = "";
        await cpLoadMessages(cpCurrentEngagementId);
      } catch (err) {
        console.error(err);
      }
    }

    async function cpLoadFiles(engagementId) {
      try {
        const res = await fetch(API_BASE + "/files/" + engagementId, {
          headers: cpAuthHeaders(),
        });

        const list = $cp("cp-files-list");
        cpClear(list);

        if (!res.ok) {
          console.error("Failed to load files");
          list.innerHTML =
            '<li class="cp-tiny-text">Could not load files for this engagement.</li>';
          return;
        }

        const files = await res.json();

        if (!files.length) {
          list.innerHTML =
            '<li class="cp-tiny-text">No files yet. Reports and exports will appear here when published.</li>';
          return;
        }

        files.forEach((f) => {
          const li = document.createElement("li");
          const a = document.createElement("a");
          a.href = f.file_url;
          a.target = "_blank";
          a.rel = "noopener noreferrer";
          a.textContent = f.filename;
          li.appendChild(a);
          list.appendChild(li);
        });
      } catch (err) {
        console.error(err);
        $cp("cp-files-list").innerHTML =
          '<li class="cp-tiny-text">Error loading files.</li>';
      }
    }

    async function cpUploadFile() {
      if (!cpAuthToken || !cpCurrentEngagementId) return;

      const input = $cp("cp-file-upload");
      if (!input.files.length) {
        $cp("cp-upload-status").textContent = "Choose a file first.";
        return;
      }

      const file = input.files[0];
      const formData = new FormData();
      formData.append("upload", file);

      $cp("cp-upload-status").textContent = "Uploading…";

      try {
        const res = await fetch(
          API_BASE + "/files/upload?engagement_id=" + cpCurrentEngagementId,
          {
            method: "POST",
            headers: { ...cpAuthHeaders() },
            body: formData,
          }
        );

        if (!res.ok) {
          console.error("Upload failed");
          $cp("cp-upload-status").textContent =
            "Upload failed. If this persists, send directly to EchoPentest.";
          return;
        }

        $cp("cp-upload-status").textContent = "File uploaded.";
        input.value = "";
        await cpLoadFiles(cpCurrentEngagementId);
      } catch (err) {
        console.error(err);
        $cp("cp-upload-status").textContent = "Upload error.";
      }
    }

    // ===== INIT =====
    document.addEventListener("DOMContentLoaded", () => {
      cpStartTypingEffect();

      $cp("cp-login-btn").addEventListener("click", cpLogin);
      $cp("cp-logout-btn").addEventListener("click", cpLogout);
      $cp("cp-send-message-btn").addEventListener("click", cpSendMessage);
      $cp("cp-upload-btn").addEventListener("click", cpUploadFile);

      $cp("cp-login-password").addEventListener("keyup", (e) => {
        if (e.key === "Enter") cpLogin();
      });
    });
  </script>
</body>
</html>
